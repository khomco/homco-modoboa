---

dependencies:
  - role: debops.secret
  - role: debops.pki
  - role: debops.mysql

    mysql_databases:
      - name: '{{ modoboa_sql_dbname }}'
        state: present

    mysql_users:
      - name: 'modoboa'
        password: '{{ lookup("password", secret + "/credentials/" + ansible_fqdn + "/" + modoboa_sql_driver + "/" + modoboa_sql_dbname + "/modoboa length=" + mysql_password_length) }}'
        host: 'localhost'
        state: present
        priv: '{{ modoboa_sql_dbname }}.*:ALL'
      - name: 'dovecot'
        password: '{{ lookup("password", secret + "/credentials/" + ansible_fqdn + "/" + modoboa_sql_driver + "/modoboa/dovecot length=" + mysql_password_length) }}'
        host: 'localhost'
        state: present
        priv: '{{modoboa_sql_dbname}}.*:ALL'

  - role: debops.dovecot

    # dovecot_protocols: [ 'imap', 'imaps', 'pop3', 'pop3s', 'managesieve', 'lmtp' ]
    dovecot_protocols: [ 'imap', 'managesieve' ]
    dovecot_auth_mechanisms: [ 'plain', 'login' ]
    dovecot_user_accounts: [ 'sql' ]
    dovecot_mail_location: 'maildir:~/.maildir'
    dovecot_pki: True
    dovecot_ssl_required: True
    dovecot_imap_config_map:
      protocol:
        mail_plugins: '$mail_plugins quota sieve'
    dovecot_lda_config_map:
      protocol:
        mail_plugins: '$mail_plugins sieve'
    dovecot_lmtp_config_map:
      service:
        unix_listener:
          /var/spool/postfix/private/dovecot-lmtp:
            user: 'postfix'
            group: 'postfix'
            mode: 0600
        protocol:
          mail_plugins: '$mail_plugins quota sieve'
          postmaster_address: 'postmaster@localhost'

  - role: debops.postfix
    postfix: [ 'local', 'network', 'mx' ]
    postfix_virtual_transport_maps: [ 'lmtp:unix:private/dovecot-lmtp' ]
    postfix_relay_domains: []
    postfix_relay_domains: [ '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-domains.cf' ]
    postfix_virtual_alias_maps: [ '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-aliases.cf',
      '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-domain-aliases-mailboxes.cf',
      '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-mailboxes-self-aliases.cf',
      '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-catchall-aliases.cf' ]
    postfix_smtpd_helo_restrictions: [ 'reject_invalid_helo_hostname', 'reject_non_fqdn_helo_hostname' ]
    postfix_smtpd_recipient_restrictions: [ 'check_recipient_access {{modoboa_sql_driver}}:/etc/postfix/maps/sql-maintain.cf',
      'permit_mynetworks', 'reject_unverified_recipient' ]
    smtpd_sender_login_maps: [ '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-sender-login-mailboxes.cf',
      '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-sender-login-aliases.cf',
      '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-sender-login-domain-aliases.cf',
      '{{modoboa_sql_driver}}:/etc/postfix/maps/sql-sender-login-catchall-aliases.cf' ]
    # postfix_smtpd_sender_restrictions: [ 'reject_sender_login_mismatch' ]
    postfix_pki: True
